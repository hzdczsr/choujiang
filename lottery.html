<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç­‘å³°ä¸€ç­å…ƒæ—¦æ™šä¼šæŠ½å¥–ç³»ç»Ÿ ğŸ²</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            padding: 20px 0;
            overflow-x: hidden;
        }

        .container {
            text-align: center;
            background: rgba(255, 255, 255, 0.95);
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            max-width: 600px;
            width: 90%;
            position: relative;
            margin: 20px auto;
            max-height: none;
            overflow: visible;
        }

        .title {
            font-size: 2.5em;
            color: #333;
            margin-bottom: 30px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
        }

        .emoji {
            font-size: 1.2em;
            animation: bounce 2s infinite;
        }

        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% {
                transform: translateY(0);
            }
            40% {
                transform: translateY(-10px);
            }
            60% {
                transform: translateY(-5px);
            }
        }

        .lottery-display {
            background: linear-gradient(45deg, #ff6b6b, #feca57);
            color: white;
            font-size: 3em;
            font-weight: bold;
            padding: 30px;
            border-radius: 15px;
            margin: 30px 0;
            min-height: 120px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .lottery-display::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, transparent, rgba(255, 255, 255, 0.1), transparent);
            transform: rotate(45deg);
            transition: all 0.5s;
            opacity: 0;
        }

        .lottery-display.spinning::before {
            animation: shine 0.5s ease-in-out;
        }

        @keyframes shine {
            0% {
                transform: translateX(-100%) translateY(-100%) rotate(45deg);
                opacity: 0;
            }
            50% {
                opacity: 1;
            }
            100% {
                transform: translateX(100%) translateY(100%) rotate(45deg);
                opacity: 0;
            }
        }

        .lottery-display.result {
            background: linear-gradient(45deg, #48cae4, #023e8a);
            animation: celebration 0.6s ease-in-out;
        }

        @keyframes celebration {
            0% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.1);
            }
            100% {
                transform: scale(1);
            }
        }

        .btn {
            background: linear-gradient(45deg, #ff9a9e, #fecfef);
            color: #333;
            border: none;
            padding: 15px 40px;
            font-size: 1.2em;
            font-weight: bold;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            margin: 10px;
            position: relative;
            overflow: hidden;
        }

        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: rgba(255, 255, 255, 0.5);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: all 0.3s;
        }

        .btn:hover::before {
            width: 300px;
            height: 300px;
        }

        .controls {
            margin-top: 30px;
        }

        .file-input {
            display: none;
        }

        .file-label {
            background: linear-gradient(45deg, #a8edea, #fed6e3);
            color: #333;
            padding: 10px 20px;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 10px;
            display: inline-block;
        }

        .file-label:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .stats {
            margin-top: 20px;
            color: #666;
            font-size: 1.1em;
        }

        .history {
            margin-top: 30px;
            max-height: 200px;
            overflow-y: auto;
            background: rgba(0, 0, 0, 0.05);
            border-radius: 10px;
            padding: 15px;
        }

        .file-info {
            background: linear-gradient(45deg, #a8edea, #fed6e3);
            color: #333;
            padding: 20px;
            border-radius: 15px;
            margin: 20px 0;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }

        .file-info.has-data {
            background: linear-gradient(45deg, #48cae4, #023e8a);
            color: white;
        }

        .file-info-title {
            font-size: 1.3em;
            font-weight: bold;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .file-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            font-size: 0.95em;
        }

        .file-detail-item {
            display: flex;
            align-items: center;
        }

        .file-detail-item .icon {
            margin-right: 8px;
            font-size: 1.1em;
        }

        .delete-btn {
            background: linear-gradient(45deg, #ff6b6b, #ee5a6f);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.3s ease;
            margin-left: 10px;
        }

        .delete-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 107, 107, 0.4);
        }

        .upload-area {
            border: 2px dashed #ddd;
            border-radius: 15px;
            padding: 30px;
            text-align: center;
            margin: 20px 0;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.5);
        }

        .upload-area:hover {
            border-color: #48cae4;
            background: rgba(72, 202, 228, 0.1);
        }

        .upload-area.dragover {
            border-color: #48cae4;
            background: rgba(72, 202, 228, 0.2);
            transform: scale(1.02);
        }

        .upload-icon {
            font-size: 3em;
            margin-bottom: 15px;
            opacity: 0.6;
        }

        .upload-text {
            font-size: 1.2em;
            color: #666;
            margin-bottom: 10px;
        }

        .upload-hint {
            font-size: 0.9em;
            color: #999;
        }

        .history-item {
            background: rgba(255, 255, 255, 0.8);
            padding: 8px 15px;
            margin: 5px 0;
            border-radius: 20px;
            display: inline-block;
            margin-right: 10px;
            font-weight: bold;
            color: #333;
        }

        .confetti {
            position: fixed;
            top: -10px;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1000;
        }

        .confetti-piece {
            position: absolute;
            width: 10px;
            height: 10px;
            background: #ff6b6b;
            animation: confetti-fall 3s linear;
        }

        @keyframes confetti-fall {
            to {
                transform: translateY(100vh) rotate(360deg);
            }
        }

        .winner-animation {
            animation: winner-glow 1s ease-in-out;
        }

        @keyframes winner-glow {
            0%, 100% {
                box-shadow: 0 0 20px #ffd700;
            }
            50% {
                box-shadow: 0 0 40px #ffd700, 0 0 60px #ffd700;
            }
        }

        /* é«˜çº§è®¾ç½®ç›¸å…³æ ·å¼ */
        .settings-btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.3s ease;
            margin-left: 10px;
        }

        .settings-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .settings-panel {
            position: fixed;
            top: 0;
            right: -400px;
            width: 400px;
            height: 100vh;
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(10px);
            box-shadow: -5px 0 20px rgba(0, 0, 0, 0.1);
            transition: right 0.3s ease;
            z-index: 1000;
            overflow-y: auto;
        }

        .settings-panel.active {
            right: 0;
        }

        .settings-header {
            padding: 20px;
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .settings-content {
            padding: 20px;
        }

        .settings-section {
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(0, 0, 0, 0.05);
            border-radius: 15px;
        }

        .settings-section h3 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.2em;
            border-bottom: 2px solid #667eea;
            padding-bottom: 8px;
        }

        .setting-item {
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .setting-label {
            font-weight: bold;
            color: #555;
        }

        .setting-input {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 0.9em;
        }

        .setting-input[type="number"] {
            width: 80px;
        }

        .setting-input[type="text"] {
            width: 150px;
        }

        .setting-checkbox {
            transform: scale(1.2);
        }

        .btn-small {
            background: linear-gradient(45deg, #ff9a9e, #fecfef);
            color: #333;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.8em;
            transition: all 0.3s ease;
            margin: 5px;
        }

        .btn-small:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .close-settings {
            background: none;
            border: none;
            color: white;
            font-size: 1.5em;
            cursor: pointer;
            padding: 5px;
        }

        .probability-list {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 10px;
            background: white;
        }

        .probability-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            border-bottom: 1px solid #eee;
        }

        .probability-item:last-child {
            border-bottom: none;
        }

        .person-name {
            font-weight: bold;
            color: #333;
        }

        .person-probability {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .person-probability input {
            width: 60px;
            padding: 4px 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .current-settings {
            background: rgba(102, 126, 234, 0.1);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .current-settings h4 {
            color: #667eea;
            margin-bottom: 10px;
        }

        .settings-status {
            font-size: 0.9em;
            color: #666;
        }

        @media (max-width: 600px) {
            .container {
                padding: 20px;
                margin: 20px;
            }
            
            .title {
                font-size: 2em;
            }
            
            .lottery-display {
                font-size: 2em;
                padding: 20px;
            }
            
            .btn {
                padding: 12px 30px;
                font-size: 1em;
            }

            .settings-panel {
                width: 100%;
                right: -100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="title">
            <span class="emoji">ğŸ²</span>
            ç­‘å³°ä¸€ç­å…ƒæ—¦æ™šä¼šæŠ½å¥–
            <span class="emoji">ğŸ‰</span>
        </h1>
        
        <!-- æ–‡ä»¶ä¿¡æ¯æ˜¾ç¤ºåŒºåŸŸ -->
        <div class="file-info" id="fileInfo">
            <div class="file-info-title">
                <span>
                    <span class="icon">ğŸ“‹</span>
                    å½“å‰è¯»å–è¡¨æ ¼åç§°
                </span>
            </div>
            <div id="fileDetails">
                <div class="file-detail-item">
                    <span class="icon">ğŸ“„</span>
                    <span>æ–‡ä»¶åï¼š</span>
                    <span id="fileName">æœªé€‰æ‹©æ–‡ä»¶</span>
                </div>
                <div class="file-detail-item">
                    <span class="icon">ğŸ“Š</span>
                    <span>å·¥ä½œè¡¨æ•°é‡ï¼š</span>
                    <span id="sheetCount">0</span>
                </div>
                <div class="file-detail-item">
                    <span class="icon">ğŸ‘¥</span>
                    <span>æ€»äººæ•°ï¼š</span>
                    <span id="totalCount">0</span>
                </div>
                <div class="file-detail-item">
                    <span class="icon">â°</span>
                    <span>ä¸Šä¼ æ—¶é—´ï¼š</span>
                    <span id="uploadTime">-</span>
                </div>
            </div>
        </div>
        
        <!-- ä¸Šä¼ åŒºåŸŸ -->
        <div class="upload-area" id="uploadArea">
            <div class="upload-icon">ğŸ“</div>
            <div class="upload-text">æ‹–æ‹½Excelæˆ–TXTæ–‡ä»¶åˆ°æ­¤å¤„æˆ–ç‚¹å‡»ä¸Šä¼ </div>
            <div class="upload-hint">æ”¯æŒ .xlsxã€.xls å’Œ .txt æ ¼å¼</div>
            <input type="file" id="fileInput" class="file-input" accept=".xlsx,.xls,.txt" onchange="loadFile(event)">
            <label for="fileInput" class="file-label">
                ğŸ“¤ é€‰æ‹©æ–‡ä»¶
            </label>
        </div>
        
        <div class="lottery-display" id="lotteryDisplay">
            è¯·å…ˆä¸Šä¼ Excelæ–‡ä»¶
        </div>
        
        <div class="controls">
            <button class="btn" id="startBtn" onclick="startLottery()" disabled>
                ğŸ¯ å¼€å§‹æŠ½å¥–
            </button>
            
            <button class="btn" id="resetBtn" onclick="resetLottery()" style="display: none;">
                ğŸ”„ é‡æ–°æŠ½å¥–
            </button>
            
            <button class="btn" id="deleteBtn" onclick="deleteData()" style="display: none;">
                ğŸ—‘ï¸ åˆ é™¤æ•°æ®
            </button>
            
            <button class="settings-btn" id="settingsBtn" onclick="toggleSettings()">
                âš™ï¸ é«˜çº§è®¾ç½®
            </button>
        </div>
        
        <div class="stats" id="stats">
            å‚ä¸äººæ•°ï¼š<span id="participantCount">0</span> äºº
        </div>
        
        <div class="history" id="history">
            <strong>ğŸ† ä¸­å¥–å†å²ï¼š</strong><br>
            æš‚æ— ä¸­å¥–è®°å½•
        </div>
    </div>

    <div class="confetti" id="confetti"></div>

    <!-- æŠ½å¥–ç»“æŸéŸ³æ•ˆ -->
    <audio id="finishSound" preload="auto">
        <source src="choujiang_finish.mp3" type="audio/mpeg">
        æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒéŸ³é¢‘æ’­æ”¾ã€‚
    </audio>

    <!-- é«˜çº§è®¾ç½®é¢æ¿ -->
    <div class="settings-panel" id="settingsPanel">
        <div class="settings-header">
            <h2>âš™ï¸ é«˜çº§è®¾ç½®</h2>
            <button class="close-settings" onclick="toggleSettings()">Ã—</button>
        </div>
        <div class="settings-content">
            <!-- å½“å‰è®¾ç½®çŠ¶æ€ -->
            <div class="current-settings">
                <h4>ğŸ“Š å½“å‰è®¾ç½®çŠ¶æ€</h4>
                <div class="settings-status" id="settingsStatus">
                    é»˜è®¤è®¾ç½®ï¼šç­‰æ¦‚ç‡æŠ½å¥–
                </div>
            </div>

            <!-- æŠ½å¥–è®¾ç½® -->
            <div class="settings-section">
                <h3>ğŸ² æŠ½å¥–è®¾ç½®</h3>
                
                <div class="setting-item">
                    <label class="setting-label">å•æ¬¡æŠ½å¥–äººæ•°ï¼š</label>
                    <input type="number" class="setting-input" id="lotteryCount" value="1" min="1" max="50" onchange="updateLotterySettings()">
                </div>
                
                <div class="setting-item">
                    <label class="setting-label">æŠ½å¥–åŠ¨ç”»æ—¶é—´(ç§’)ï¼š</label>
                    <input type="number" class="setting-input" id="animationDuration" value="3" min="1" max="10" step="0.5" onchange="updateLotterySettings()">
                </div>
                
                <div class="setting-item">
                    <label class="setting-label">éŸ³æ•ˆï¼š</label>
                    <input type="checkbox" class="setting-checkbox" id="soundEnabled" checked onchange="updateLotterySettings()">
                </div>
                
                <div class="setting-item">
                    <label class="setting-label">å½©å¸¦æ•ˆæœï¼š</label>
                    <input type="checkbox" class="setting-checkbox" id="confettiEnabled" checked onchange="updateLotterySettings()">
                </div>
            </div>

            <!-- ä¸ªäººæ¦‚ç‡è®¾ç½® -->
            <div class="settings-section">
                <h3>ğŸ¯ ä¸ªäººæ¦‚ç‡è®¾ç½®</h3>
                
                <div class="setting-item">
                    <label class="setting-label">å¯ç”¨ä¸ªäººæ¦‚ç‡ï¼š</label>
                    <input type="checkbox" class="setting-checkbox" id="customProbabilityEnabled" onchange="toggleCustomProbability()">
                </div>
                
                <div class="setting-item">
                    <label class="setting-label">å¿«é€Ÿè®¾ç½®ï¼š</label>
                    <div>
                        <button class="btn-small" onclick="setAllProbability(10)">ç­‰æ¦‚ç‡(10%)</button>
                        <button class="btn-small" onclick="setAllProbability(5)">ç­‰æ¦‚ç‡(5%)</button>
                        <button class="btn-small" onclick="resetToDefault()">é‡ç½®ä¸ºé»˜è®¤</button>
                    </div>
                </div>
                
                <div id="probabilityList" class="probability-list" style="display: none;">
                    <!-- ä¸ªäººæ¦‚ç‡è®¾ç½®åˆ—è¡¨å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
                </div>
                
                <div class="setting-item">
                    <button class="btn-small" onclick="saveProbabilitySettings()">ğŸ’¾ ä¿å­˜æ¦‚ç‡è®¾ç½®</button>
                    <button class="btn-small" onclick="loadProbabilitySettings()">ğŸ“‚ åŠ è½½è®¾ç½®</button>
                </div>
            </div>

            <!-- ä½œå¼Šè®¾ç½® -->
            <div class="settings-section">
                <h3>ğŸ•µï¸ ä½œå¼Šè®¾ç½® (éšè—)</h3>
                
                <div class="setting-item">
                    <label class="setting-label">æŒ‡å®šä¸­å¥–äººï¼š</label>
                    <input type="text" class="setting-input" id="forceWinner" placeholder="è¾“å…¥å§“åå¼ºåˆ¶ä¸­å¥–" onchange="updateForceWinner()">
                </div>
                
                <div class="setting-item">
                    <label class="setting-label">æ’é™¤äººå‘˜ï¼š</label>
                    <input type="text" class="setting-input" id="excludeNames" placeholder="ç”¨é€—å·åˆ†éš”å¤šä¸ªå§“å" onchange="updateExcludedNames()">
                </div>
                
                <div class="setting-item">
                    <label class="setting-label">éšè—ä½œå¼Šæ¨¡å¼ï¼š</label>
                    <input type="checkbox" class="setting-checkbox" id="hideCheating" checked onchange="updateHideCheating()">
                </div>
                
                <div class="setting-item">
                    <label class="setting-label">è¿ç»­åŒä¸€äººæ¦‚ç‡ï¼š</label>
                    <input type="number" class="setting-input" id="repeatChance" value="0" min="0" max="100" step="5" onchange="updateRepeatChance()">
                    <span>% (0=ç¦ç”¨)</span>
                </div>
            </div>

            <!-- æ•°æ®ç®¡ç† -->
            <div class="settings-section">
                <h3>ğŸ’¾ æ•°æ®ç®¡ç†</h3>
                
                <div class="setting-item">
                    <button class="btn-small" onclick="exportSettings()">ğŸ“¤ å¯¼å‡ºè®¾ç½®</button>
                    <button class="btn-small" onclick="importSettings()">ğŸ“¥ å¯¼å…¥è®¾ç½®</button>
                </div>
                
                <div class="setting-item">
                    <button class="btn-small" onclick="resetAllSettings()">ğŸ”„ é‡ç½®æ‰€æœ‰è®¾ç½®</button>
                    <button class="btn-small" onclick="clearAllData()">ğŸ—‘ï¸ æ¸…ç©ºæ‰€æœ‰æ•°æ®</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let names = [];
        let currentData = null;
        let isDrawing = false;
        let currentWinner = null;
        let history = [];
        
        // é«˜çº§è®¾ç½®ç›¸å…³å˜é‡
        let advancedSettings = {
            lotteryCount: 1,
            animationDuration: 3,
            soundEnabled: true,
            confettiEnabled: true,
            customProbabilityEnabled: false,
            forceWinner: '',
            excludeNames: [],
            hideCheating: true,
            repeatChance: 0,
            probabilities: {} // {å§“å: æ¦‚ç‡}
        };
        
        // æœ¬åœ°å­˜å‚¨é”®å
        const STORAGE_KEY = 'lottery_data';
        const HISTORY_KEY = 'lottery_history';
        const SETTINGS_KEY = 'advanced_settings';

        // éªŒè¯æ˜¯å¦ä¸ºæœ‰æ•ˆå§“åçš„å‡½æ•°
        function isValidName(text) {
            if (!text || typeof text !== 'string') return false;
            
            const trimmed = text.trim();
            if (!trimmed || trimmed.length === 0) return false;
            
            // æ’é™¤æ˜æ˜¾ä¸æ˜¯å§“åçš„æƒ…å†µ
            const invalidPatterns = [
                'nan', 'null', 'undefined', 'error', 'é”™è¯¯',
                'å·¥ä½œè¡¨', 'sheet', 'è¡¨', 'é¡µ', 'å§“å', 'åå­—', 'name',
                'å­¦ç”Ÿ', 'äººå‘˜', 'æˆå‘˜', 'åˆ—è¡¨', 'list', 'table', 'è¡¨æ ¼',
                'æµ‹è¯•', 'test', 'ç¤ºä¾‹', 'sample', 'demo',
                // æ•°å­—å¼€å¤´çš„
                /^\d/, /^[0-9]/,
                // åŒ…å«ç‰¹æ®Šå…³é”®è¯çš„
                'åˆè®¡', 'å°è®¡', 'å¹³å‡', 'æ€»æ•°', 'æ•°é‡',
                // Excelå‡½æ•°æˆ–å…¬å¼
                'sum', 'count', 'average', 'max', 'min',
                // è¡Œæ”¿åŒºåˆ’ç›¸å…³
                'çœ', 'å¸‚', 'å¿', 'åŒº', 'é•‡', 'ä¹¡', 'æ‘', 'è¡—é“',
                'åŒ—äº¬', 'ä¸Šæµ·', 'å¤©æ´¥', 'é‡åº†', 'æ²³åŒ—', 'å±±è¥¿', 'è¾½å®',
                'å‰æ—', 'é»‘é¾™æ±Ÿ', 'æ±Ÿè‹', 'æµ™æ±Ÿ', 'å®‰å¾½', 'ç¦å»º', 'æ±Ÿè¥¿',
                'å±±ä¸œ', 'æ²³å—', 'æ¹–åŒ—', 'æ¹–å—', 'å¹¿ä¸œ', 'å¹¿è¥¿', 'æµ·å—',
                'å››å·', 'è´µå·', 'äº‘å—', 'è¥¿è—', 'é™•è¥¿', 'ç”˜è‚ƒ', 'é’æµ·',
                'å®å¤', 'æ–°ç–†', 'å†…è’™å¤', 'å°æ¹¾', 'é¦™æ¸¯', 'æ¾³é—¨',
                // è¡Œæ”¿åŒºåˆ’ä»£ç æ ¼å¼ï¼ˆå¦‚110000, 110100ç­‰ï¼‰
                /^\d{6}$/, /^\d{4}$/,
                // åŒ…å«å®Œæ•´åŒºå·çš„åŸå¸‚å
                'åŒ—äº¬å¸‚', 'ä¸Šæµ·å¸‚', 'å¤©æ´¥å¸‚', 'é‡åº†å¸‚',
                // å¸¸è§çš„éå§“åè¯æ±‡
                'å…¬å¸', 'ä¼ä¸š', 'æœºæ„', 'éƒ¨é—¨', 'å•ä½', 'ç»„ç»‡',
                'ç¬¬ä¸€', 'ç¬¬äºŒ', 'ç¬¬ä¸‰', 'ç¬¬å››', 'ç¬¬äº”',
                'ä¸œ', 'è¥¿', 'å—', 'åŒ—', 'ä¸­', 'å‰', 'å', 'å·¦', 'å³'
            ];
            
            // æ£€æŸ¥æ— æ•ˆæ¨¡å¼
            for (const pattern of invalidPatterns) {
                if (pattern instanceof RegExp) {
                    if (pattern.test(trimmed)) return false;
                } else if (trimmed.toLowerCase().includes(pattern.toLowerCase())) {
                    return false;
                }
            }
            
            // å§“åçš„é•¿åº¦é™åˆ¶ï¼ˆ2-8ä¸ªå­—ç¬¦ï¼‰
            if (trimmed.length < 2 || trimmed.length > 8) return false;
            
            // æ£€æŸ¥æ˜¯å¦åŒ…å«ä¸åˆé€‚çš„å­—ç¬¦
            const invalidChars = /[<>{}[\]()@#$%^&*+=|\\:";'<>?/,.~`]/;
            if (invalidChars.test(trimmed)) return false;
            
            // å§“åå­—ç¬¦éªŒè¯ï¼ˆå…è®¸ä¸­æ–‡ã€è‹±æ–‡ã€æ•°å­—ã€ç©ºæ ¼ï¼‰
            const namePattern = /^[ä¸€-é¾¥a-zA-Z0-9\s\-_\.\(\)ï¼ˆï¼‰]+$/;
            if (!namePattern.test(trimmed)) return false;
            
            // é¢å¤–æ£€æŸ¥ï¼šç¡®ä¿ä¸æ˜¯çº¯æ•°å­—æˆ–ç‰¹æ®Šæ ¼å¼
            if (/^\d+$/.test(trimmed)) return false;
            
            // æ£€æŸ¥æ˜¯å¦åŒ…å«è¿‡å¤šçš„æ•°å­—ï¼ˆå¯èƒ½æ˜¯ç¼–å·ï¼‰
            const digitCount = (trimmed.match(/\d/g) || []).length;
            if (digitCount > 2) return false;
            
            return true;
        }

        // éŸ³æ•ˆç”Ÿæˆå‡½æ•° - å–œåº†è¿‡å¹´ç‰ˆ
        function playSound(type) {
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            
            // åˆ›å»ºåŸºç¡€éŸ³è°ƒ
            function createTone(frequency, duration, volume = 0.1, waveType = 'sine') {
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.value = frequency;
                oscillator.type = waveType;
                
                gainNode.gain.setValueAtTime(0, audioContext.currentTime);
                gainNode.gain.linearRampToValueAtTime(volume, audioContext.currentTime + 0.01);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + duration);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + duration);
            }
            
            // åˆ›å»ºé”£é¼“å£°æ•ˆ
            function createDrumSound(frequency, duration, volume = 0.2) {
                // ä½é¢‘æŒ¯è¡å™¨æ¨¡æ‹Ÿé¼“å£°
                const drumOsc = audioContext.createOscillator();
                const drumGain = audioContext.createGain();
                const drumFilter = audioContext.createBiquadFilter();
                
                drumOsc.connect(drumFilter);
                drumFilter.connect(drumGain);
                drumGain.connect(audioContext.destination);
                
                drumOsc.frequency.setValueAtTime(frequency, audioContext.currentTime);
                drumOsc.frequency.exponentialRampToValueAtTime(frequency * 0.3, audioContext.currentTime + duration);
                
                drumOsc.type = 'sawtooth';
                drumFilter.type = 'lowpass';
                drumFilter.frequency.setValueAtTime(200, audioContext.currentTime);
                
                drumGain.gain.setValueAtTime(volume, audioContext.currentTime);
                drumGain.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + duration);
                
                drumOsc.start(audioContext.currentTime);
                drumOsc.stop(audioContext.currentTime + duration);
            }
            
            // åˆ›å»ºé“ƒé“›å£°æ•ˆ
            function createBellSound(frequency, duration, volume = 0.15) {
                const bellOsc = audioContext.createOscillator();
                const bellGain = audioContext.createGain();
                
                bellOsc.connect(bellGain);
                bellGain.connect(audioContext.destination);
                
                bellOsc.frequency.value = frequency;
                bellOsc.type = 'triangle';
                
                bellGain.gain.setValueAtTime(0, audioContext.currentTime);
                bellGain.gain.linearRampToValueAtTime(volume, audioContext.currentTime + 0.02);
                bellGain.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + duration);
                
                bellOsc.start(audioContext.currentTime);
                bellOsc.stop(audioContext.currentTime + duration);
            }
            
            // åˆ›å»ºå’Œå£°éŸ³æ•ˆ
            function createHarmony(frequencies, duration, volume = 0.08) {
                frequencies.forEach((freq, index) => {
                    setTimeout(() => {
                        createTone(freq, duration, volume, 'sine');
                    }, index * 50);
                });
            }

            switch (type) {
                case 'start':
                    // å¼€å§‹éŸ³æ•ˆ - ç®€çŸ­çš„æç¤ºéŸ³
                    createTone(523, 0.1, 0.15, 'triangle'); // ç¬›å£°
                    setTimeout(() => createTone(659, 0.1, 0.15, 'triangle'), 100);
                    setTimeout(() => createTone(784, 0.1, 0.15, 'triangle'), 200);
                    break;
                    

                    
                case 'winner':
                    // è·å¥–éŸ³æ•ˆ - åº†ç¥é”£é¼“å’Œé“ƒé“›
                    // é”£é¼“å£°
                    createDrumSound(100, 0.3, 0.3);
                    setTimeout(() => createDrumSound(120, 0.25, 0.25), 200);
                    setTimeout(() => createDrumSound(150, 0.2, 0.2), 400);
                    
                    // é“ƒé“›å£°
                    setTimeout(() => createBellSound(1047, 0.4, 0.2), 600); // é«˜éŸ³é“ƒé“›
                    setTimeout(() => createBellSound(1319, 0.3, 0.15), 800); // æ›´é«˜éŸ³é“ƒé“›
                    
                    // åº†ç¥å’Œå£°
                    setTimeout(() => {
                        createHarmony([523, 659, 784, 1047], 0.6, 0.1);
                    }, 1000);
                    
                    // æœ€åçš„é”£å£°
                    setTimeout(() => createDrumSound(60, 0.5, 0.25), 1200);
                    break;
            }
        }

        // åˆ›å»ºå½©å¸¦æ•ˆæœ
        function createConfetti() {
            const confettiContainer = document.getElementById('confetti');
            const colors = ['#ff6b6b', '#4ecdc4', '#45b7d1', '#96ceb4', '#feca57', '#ff9ff3', '#54a0ff'];
            
            for (let i = 0; i < 50; i++) {
                const confettiPiece = document.createElement('div');
                confettiPiece.className = 'confetti-piece';
                confettiPiece.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                confettiPiece.style.left = Math.random() * 100 + '%';
                confettiPiece.style.animationDelay = Math.random() * 3 + 's';
                confettiPiece.style.animationDuration = (Math.random() * 3 + 2) + 's';
                
                confettiContainer.appendChild(confettiPiece);
                
                setTimeout(() => {
                    confettiContainer.removeChild(confettiPiece);
                }, 5000);
            }
        }

        // ============ é«˜çº§è®¾ç½®ç›¸å…³å‡½æ•° ============
        
        // åˆ‡æ¢è®¾ç½®é¢æ¿
        function toggleSettings() {
            const panel = document.getElementById('settingsPanel');
            panel.classList.toggle('active');
            if (panel.classList.contains('active')) {
                updateSettingsDisplay();
            }
        }
        
        // æ›´æ–°è®¾ç½®æ˜¾ç¤º
        function updateSettingsDisplay() {
            document.getElementById('lotteryCount').value = advancedSettings.lotteryCount;
            document.getElementById('animationDuration').value = advancedSettings.animationDuration;
            document.getElementById('soundEnabled').checked = advancedSettings.soundEnabled;
            document.getElementById('confettiEnabled').checked = advancedSettings.confettiEnabled;
            document.getElementById('customProbabilityEnabled').checked = advancedSettings.customProbabilityEnabled;
            document.getElementById('forceWinner').value = advancedSettings.forceWinner;
            document.getElementById('excludeNames').value = advancedSettings.excludeNames.join(', ');
            document.getElementById('hideCheating').checked = advancedSettings.hideCheating;
            document.getElementById('repeatChance').value = advancedSettings.repeatChance;
            
            // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
            updateSettingsStatus();
            
            // å¦‚æœå¯ç”¨äº†ä¸ªäººæ¦‚ç‡ï¼Œæ˜¾ç¤ºæ¦‚ç‡åˆ—è¡¨
            if (advancedSettings.customProbabilityEnabled) {
                showProbabilityList();
            }
        }
        
        // æ›´æ–°è®¾ç½®çŠ¶æ€æ˜¾ç¤º
        function updateSettingsStatus() {
            const status = document.getElementById('settingsStatus');
            let statusText = '';
            
            if (advancedSettings.customProbabilityEnabled) {
                statusText = 'è‡ªå®šä¹‰æ¦‚ç‡æŠ½å¥–';
            } else {
                statusText = 'ç­‰æ¦‚ç‡æŠ½å¥–';
            }
            
            if (advancedSettings.forceWinner) {
                statusText += ` | å¼ºåˆ¶ä¸­å¥–: ${advancedSettings.forceWinner}`;
            }
            
            if (advancedSettings.excludeNames.length > 0) {
                statusText += ` | æ’é™¤: ${advancedSettings.excludeNames.join(', ')}`;
            }
            
            if (advancedSettings.repeatChance > 0) {
                statusText += ` | è¿ç»­ä¸­å¥–æ¦‚ç‡: ${advancedSettings.repeatChance}%`;
            }
            
            status.textContent = statusText || 'é»˜è®¤è®¾ç½®ï¼šç­‰æ¦‚ç‡æŠ½å¥–';
        }
        
        // æ›´æ–°æŠ½å¥–è®¾ç½®
        function updateLotterySettings() {
            advancedSettings.lotteryCount = parseInt(document.getElementById('lotteryCount').value) || 1;
            advancedSettings.animationDuration = parseFloat(document.getElementById('animationDuration').value) || 3;
            advancedSettings.soundEnabled = document.getElementById('soundEnabled').checked;
            advancedSettings.confettiEnabled = document.getElementById('confettiEnabled').checked;
            
            saveSettings();
            updateSettingsStatus();
        }
        
        // åˆ‡æ¢ä¸ªäººæ¦‚ç‡è®¾ç½®
        function toggleCustomProbability() {
            advancedSettings.customProbabilityEnabled = document.getElementById('customProbabilityEnabled').checked;
            
            if (advancedSettings.customProbabilityEnabled && names.length > 0) {
                showProbabilityList();
            } else {
                document.getElementById('probabilityList').style.display = 'none';
            }
            
            saveSettings();
            updateSettingsStatus();
        }
        
        // æ˜¾ç¤ºä¸ªäººæ¦‚ç‡è®¾ç½®åˆ—è¡¨
        function showProbabilityList() {
            const container = document.getElementById('probabilityList');
            container.innerHTML = '';
            
            names.forEach(name => {
                const currentProb = advancedSettings.probabilities[name] || (100 / names.length);
                const item = document.createElement('div');
                item.className = 'probability-item';
                item.innerHTML = `
                    <span class="person-name">${name}</span>
                    <div class="person-probability">
                        <input type="number" value="${currentProb}" min="0" max="100" step="0.1" 
                               onchange="updatePersonProbability('${name}', this.value)">
                        <span>%</span>
                    </div>
                `;
                container.appendChild(item);
            });
            
            container.style.display = 'block';
        }
        
        // æ›´æ–°ä¸ªäººæ¦‚ç‡
        function updatePersonProbability(name, value) {
            const prob = parseFloat(value) || 0;
            if (prob >= 0 && prob <= 100) {
                advancedSettings.probabilities[name] = prob;
            }
        }
        
        // è®¾ç½®æ‰€æœ‰äººç­‰æ¦‚ç‡
        function setAllProbability(percentage) {
            if (names.length === 0) {
                alert('è¯·å…ˆåŠ è½½å§“ååˆ—è¡¨');
                return;
            }
            
            const probPerPerson = percentage / names.length;
            names.forEach(name => {
                advancedSettings.probabilities[name] = probPerPerson;
            });
            
            showProbabilityList();
        }
        
        // é‡ç½®ä¸ºé»˜è®¤è®¾ç½®
        function resetToDefault() {
            advancedSettings.probabilities = {};
            showProbabilityList();
        }
        
        // ä¿å­˜æ¦‚ç‡è®¾ç½®
        function saveProbabilitySettings() {
            // éªŒè¯æ¦‚ç‡æ€»å’Œ
            const totalProb = Object.values(advancedSettings.probabilities).reduce((sum, prob) => sum + prob, 0);
            if (Math.abs(totalProb - 100) > 0.1) {
                if (!confirm(`å½“å‰æ¦‚ç‡æ€»å’Œä¸º ${totalProb.toFixed(1)}%ï¼Œä¸ç­‰äº100%ã€‚æ˜¯å¦ç»§ç»­ä¿å­˜ï¼Ÿ`)) {
                    return;
                }
            }
            
            saveSettings();
            alert('æ¦‚ç‡è®¾ç½®å·²ä¿å­˜ï¼');
        }
        
        // åŠ è½½æ¦‚ç‡è®¾ç½®
        function loadProbabilitySettings() {
            const stored = localStorage.getItem(SETTINGS_KEY);
            if (stored) {
                try {
                    const settings = JSON.parse(stored);
                    if (settings.probabilities) {
                        advancedSettings.probabilities = settings.probabilities;
                        showProbabilityList();
                        alert('æ¦‚ç‡è®¾ç½®å·²åŠ è½½ï¼');
                    }
                } catch (error) {
                    alert('åŠ è½½è®¾ç½®å¤±è´¥ï¼');
                }
            } else {
                alert('æ²¡æœ‰æ‰¾åˆ°ä¿å­˜çš„è®¾ç½®ï¼');
            }
        }
        
        // æ›´æ–°å¼ºåˆ¶ä¸­å¥–äºº
        function updateForceWinner() {
            advancedSettings.forceWinner = document.getElementById('forceWinner').value.trim();
            saveSettings();
            updateSettingsStatus();
        }
        
        // æ›´æ–°æ’é™¤äººå‘˜
        function updateExcludedNames() {
            const input = document.getElementById('excludeNames').value;
            advancedSettings.excludeNames = input.split(',').map(name => name.trim()).filter(name => name);
            saveSettings();
            updateSettingsStatus();
        }
        
        // æ›´æ–°éšè—ä½œå¼Šæ¨¡å¼
        function updateHideCheating() {
            advancedSettings.hideCheating = document.getElementById('hideCheating').checked;
            saveSettings();
        }
        
        // æ›´æ–°è¿ç»­åŒä¸€äººæ¦‚ç‡
        function updateRepeatChance() {
            advancedSettings.repeatChance = parseInt(document.getElementById('repeatChance').value) || 0;
            saveSettings();
            updateSettingsStatus();
        }
        
        // å¯¼å‡ºè®¾ç½®
        function exportSettings() {
            const dataStr = JSON.stringify(advancedSettings, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            
            const link = document.createElement('a');
            link.href = url;
            link.download = `lottery_settings_${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            
            URL.revokeObjectURL(url);
        }
        
        // å¯¼å…¥è®¾ç½®
        function importSettings() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const settings = JSON.parse(e.target.result);
                        advancedSettings = { ...advancedSettings, ...settings };
                        updateSettingsDisplay();
                        saveSettings();
                        alert('è®¾ç½®å¯¼å…¥æˆåŠŸï¼');
                    } catch (error) {
                        alert('è®¾ç½®æ–‡ä»¶æ ¼å¼é”™è¯¯ï¼');
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }
        
        // é‡ç½®æ‰€æœ‰è®¾ç½®
        function resetAllSettings() {
            if (confirm('ç¡®å®šè¦é‡ç½®æ‰€æœ‰é«˜çº§è®¾ç½®å—ï¼Ÿ')) {
                advancedSettings = {
                    lotteryCount: 1,
                    animationDuration: 3,
                    soundEnabled: true,
                    confettiEnabled: true,
                    customProbabilityEnabled: false,
                    forceWinner: '',
                    excludeNames: [],
                    hideCheating: true,
                    repeatChance: 0,
                    probabilities: {}
                };
                updateSettingsDisplay();
                saveSettings();
                alert('æ‰€æœ‰è®¾ç½®å·²é‡ç½®ï¼');
            }
        }
        
        // æ¸…ç©ºæ‰€æœ‰æ•°æ®
        function clearAllData() {
            if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æ•°æ®å—ï¼Ÿè¿™å°†åˆ é™¤å§“åã€å†å²è®°å½•å’Œæ‰€æœ‰è®¾ç½®ã€‚')) {
                localStorage.removeItem(STORAGE_KEY);
                localStorage.removeItem(HISTORY_KEY);
                localStorage.removeItem(SETTINGS_KEY);
                
                // é‡ç½®æ‰€æœ‰æ•°æ®
                currentData = null;
                names = [];
                history = [];
                advancedSettings = {
                    lotteryCount: 1,
                    animationDuration: 3,
                    soundEnabled: true,
                    confettiEnabled: true,
                    customProbabilityEnabled: false,
                    forceWinner: '',
                    excludeNames: [],
                    hideCheating: true,
                    repeatChance: 0,
                    probabilities: {}
                };
                
                // æ›´æ–°ç•Œé¢
                updateFileInfo();
                updateStats();
                resetLottery();
                updateHistoryDisplay();
                updateSettingsDisplay();
                
                alert('æ‰€æœ‰æ•°æ®å·²æ¸…ç©ºï¼');
            }
        }
        
        // ä¿å­˜è®¾ç½®åˆ°æœ¬åœ°å­˜å‚¨
        function saveSettings() {
            localStorage.setItem(SETTINGS_KEY, JSON.stringify(advancedSettings));
        }
        
        // åŠ è½½è®¾ç½®ä»æœ¬åœ°å­˜å‚¨
        function loadSettings() {
            const stored = localStorage.getItem(SETTINGS_KEY);
            if (stored) {
                try {
                    const settings = JSON.parse(stored);
                    advancedSettings = { ...advancedSettings, ...settings };
                } catch (error) {
                    console.error('åŠ è½½è®¾ç½®å¤±è´¥ï¼š', error);
                }
            }
        }
        
        // åŠ æƒéšæœºé€‰æ‹©å‡½æ•°
        function weightedRandomSelection(candidates, weights) {
            const totalWeight = weights.reduce((sum, weight) => sum + weight, 0);
            let random = Math.random() * totalWeight;
            
            for (let i = 0; i < candidates.length; i++) {
                random -= weights[i];
                if (random <= 0) {
                    return candidates[i];
                }
            }
            
            return candidates[candidates.length - 1];
        }
        
        // è·å–å¯å‚ä¸æŠ½å¥–çš„å€™é€‰äºº
        function getLotteryCandidates() {
            let candidates = [...names];
            
            // æ’é™¤æŒ‡å®šäººå‘˜
            if (advancedSettings.excludeNames.length > 0) {
                candidates = candidates.filter(name => !advancedSettings.excludeNames.includes(name));
            }
            
            // å¦‚æœå¯ç”¨äº†è¿ç»­åŒä¸€äººæ¦‚ç‡ï¼Œæ£€æŸ¥ä¸Šä¸€æ¬¡ä¸­å¥–è€…
            if (advancedSettings.repeatChance > 0 && history.length > 0) {
                const lastWinner = history[0].name;
                if (!candidates.includes(lastWinner)) {
                    // ä¸Šä¸€æ¬¡ä¸­å¥–è€…è¢«æ’é™¤äº†ï¼Œä¸åšä»»ä½•å¤„ç†
                } else {
                    const repeatChance = advancedSettings.repeatChance / 100;
                    if (Math.random() < repeatChance) {
                        // è¿ç»­åŒä¸€äºº
                        return [lastWinner];
                    }
                }
            }
            
            return candidates;
        }
        
        // å¼€å§‹æŠ½å¥–
        function startLottery() {
            if (isDrawing || names.length === 0) return;
            
            isDrawing = true;
            const display = document.getElementById('lotteryDisplay');
            const startBtn = document.getElementById('startBtn');
            const resetBtn = document.getElementById('resetBtn');
            
            startBtn.disabled = true;
            display.className = 'lottery-display spinning';
            
            if (advancedSettings.soundEnabled) {
                playSound('start');
            }
            
            // è·å–å€™é€‰äºº
            const candidates = getLotteryCandidates();
            if (candidates.length === 0) {
                alert('æ²¡æœ‰å¯å‚ä¸æŠ½å¥–çš„äººå‘˜ï¼');
                isDrawing = false;
                startBtn.disabled = false;
                return;
            }
            
            // ç¡®å®šæŠ½å¥–äººæ•°
            const lotteryCount = Math.min(advancedSettings.lotteryCount, candidates.length);
            
            let spinCount = 0;
            const maxSpins = Math.floor(advancedSettings.animationDuration * 30); // æ¯ç§’30å¸§
            const spinInterval = 1000 / 30; // 30FPS
            
            const spinTimer = setInterval(() => {
                let displayNames = [];
                
                // åŠ¨ç”»æ˜¾ç¤ºéšæœºå§“å
                for (let i = 0; i < lotteryCount; i++) {
                    const randomName = candidates[Math.floor(Math.random() * candidates.length)];
                    displayNames.push(randomName);
                }
                
                display.textContent = displayNames.join(', ');
                
                spinCount++;
                
                if (spinCount >= maxSpins) {
                    clearInterval(spinTimer);
                    
                    // æœ€ç»ˆç»“æœè®¡ç®—
                    let winners = [];
                    
                    if (advancedSettings.forceWinner && candidates.includes(advancedSettings.forceWinner)) {
                        // å¼ºåˆ¶ä¸­å¥–æ¨¡å¼
                        winners = [advancedSettings.forceWinner];
                        // å¦‚æœéœ€è¦å¤šä¸ªä¸­å¥–è€…ï¼Œä»å‰©ä½™å€™é€‰äººä¸­éšæœºé€‰æ‹©
                        let remainingCandidates = candidates.filter(name => name !== advancedSettings.forceWinner);
                        while (winners.length < lotteryCount && remainingCandidates.length > 0) {
                            const randomIndex = Math.floor(Math.random() * remainingCandidates.length);
                            winners.push(remainingCandidates[randomIndex]);
                            remainingCandidates.splice(randomIndex, 1);
                        }
                    } else if (advancedSettings.customProbabilityEnabled && Object.keys(advancedSettings.probabilities).length > 0) {
                        // è‡ªå®šä¹‰æ¦‚ç‡æ¨¡å¼
                        const availableCandidates = candidates.filter(name => advancedSettings.probabilities[name] !== undefined);
                        const weights = availableCandidates.map(name => advancedSettings.probabilities[name]);
                        
                        for (let i = 0; i < lotteryCount; i++) {
                            if (availableCandidates.length === 0) break;
                            
                            // å¦‚æœä¸å…è®¸é‡å¤ä¸­å¥–ï¼Œä»å€™é€‰åˆ—è¡¨ä¸­ç§»é™¤å·²ä¸­å¥–è€…
                            let currentCandidates = [...availableCandidates];
                            let currentWeights = [...weights];
                            
                            if (i > 0) {
                                // ç§»é™¤å·²ä¸­å¥–è€…
                                for (const winner of winners) {
                                    const index = currentCandidates.indexOf(winner);
                                    if (index > -1) {
                                        currentCandidates.splice(index, 1);
                                        currentWeights.splice(index, 1);
                                    }
                                }
                            }
                            
                            if (currentCandidates.length > 0) {
                                const winner = weightedRandomSelection(currentCandidates, currentWeights);
                                winners.push(winner);
                            }
                        }
                    } else {
                        // ç­‰æ¦‚ç‡æ¨¡å¼
                        const shuffled = [...candidates].sort(() => Math.random() - 0.5);
                        winners = shuffled.slice(0, lotteryCount);
                    }
                    
                    // æ˜¾ç¤ºç»“æœ
                    display.textContent = winners.join(', ');
                    display.className = 'lottery-display result winner-animation';
                    
                    if (advancedSettings.soundEnabled) {
                        playSound('winner');
                        // æ’­æ”¾æŠ½å¥–ç»“æŸéŸ³æ•ˆ
                        setTimeout(() => {
                            const finishSound = document.getElementById('finishSound');
                            if (finishSound) {
                                finishSound.currentTime = 0;
                                finishSound.play().catch(e => console.log('éŸ³é¢‘æ’­æ”¾å¤±è´¥:', e));
                            }
                        }, 800); // å»¶è¿Ÿ800msæ’­æ”¾ï¼Œè®©ä¸­å¥–éŸ³æ•ˆå…ˆæ’­æ”¾
                    }
                    
                    if (advancedSettings.confettiEnabled) {
                        createConfetti();
                    }
                    
                    // æ·»åŠ åˆ°å†å²è®°å½•
                    winners.forEach(winner => {
                        addToHistory(winner);
                    });
                    
                    currentWinner = winners.join(', ');
                    
                    // æ›´æ–°æŒ‰é’®çŠ¶æ€
                    startBtn.style.display = 'none';
                    resetBtn.style.display = 'inline-block';
                    
                    isDrawing = false;
                }
            }, spinInterval);
        }

        // é‡ç½®æŠ½å¥–
        function resetLottery() {
            const display = document.getElementById('lotteryDisplay');
            const startBtn = document.getElementById('startBtn');
            const resetBtn = document.getElementById('resetBtn');
            
            display.textContent = 'ç‚¹å‡»å¼€å§‹æŠ½å¥–';
            display.className = 'lottery-display';
            
            startBtn.style.display = 'inline-block';
            resetBtn.style.display = 'none';
            
            startBtn.disabled = false;
        }

        // æ·»åŠ åˆ°å†å²è®°å½•
        function addToHistory(winner) {
            history.unshift({
                name: winner,
                time: new Date().toLocaleTimeString()
            });
            
            if (history.length > 10) {
                history.pop();
            }
            
            updateHistoryDisplay();
            saveHistory();
        }

        // æ›´æ–°å†å²æ˜¾ç¤º
        function updateHistoryDisplay() {
            const historyDiv = document.getElementById('history');
            
            if (history.length === 0) {
                historyDiv.innerHTML = '<strong>ğŸ† ä¸­å¥–å†å²ï¼š</strong><br>æš‚æ— ä¸­å¥–è®°å½•';
                return;
            }
            
            let historyHTML = '<strong>ğŸ† ä¸­å¥–å†å²ï¼š</strong><br>';
            history.forEach((record, index) => {
                historyHTML += `<span class="history-item">${record.name} (${record.time})</span>`;
            });
            
            historyDiv.innerHTML = historyHTML;
        }

        // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
        function updateStats() {
            document.getElementById('participantCount').textContent = names.length;
        }

        // åŠ è½½Excelæ–‡ä»¶
        function loadFile(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            if (!file.name.match(/\.(xlsx|xls|txt)$/i)) {
                alert('è¯·é€‰æ‹©Excelæ–‡ä»¶ï¼ˆ.xlsx æˆ– .xlsï¼‰æˆ–TXTæ–‡ä»¶ï¼ˆ.txtï¼‰');
                return;
            }
            
            // å¦‚æœæ˜¯TXTæ–‡ä»¶ï¼Œä½¿ç”¨TXTè§£ææ–¹å¼
            if (file.name.match(/\.(txt)$/i)) {
                loadTXTFile(file);
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    
                    const allNames = [];
                    const sheetData = {};
                    const sheetNames = workbook.SheetNames;
                    
                    // éå†æ‰€æœ‰å·¥ä½œè¡¨
                    sheetNames.forEach(sheetName => {
                        const worksheet = workbook.Sheets[sheetName];
                        const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, raw: false });
                        
                        const sheetNamesList = [];
                        const invalidHeaders = ['å§“å', 'åå­—', 'name', 'å­¦ç”Ÿ', 'å­¦ç”Ÿå§“å', 'äººå‘˜', 'æˆå‘˜', 'äººå‘˜å§“å', 'å§“ååˆ—è¡¨', 'æˆå‘˜åˆ—è¡¨'];
                        
                        // éå†æ‰€æœ‰è¡Œï¼Œè·³è¿‡è¡¨å¤´
                        jsonData.forEach((row, rowIndex) => {
                            // è·³è¿‡ç¬¬ä¸€è¡Œï¼ˆé€šå¸¸æ˜¯è¡¨å¤´ï¼‰
                            if (rowIndex === 0) return;
                            
                            row.forEach(cell => {
                                if (cell && cell.toString().trim()) {
                                    const name = cell.toString().trim();
                                    
                                    // ä¸¥æ ¼çš„å§“åéªŒè¯
                                    if (isValidName(name)) {
                                        sheetNamesList.push(name);
                                        allNames.push(name);
                                    }
                                }
                            });
                        });
                        
                        // å»é‡
                        const uniqueSheetNames = [...new Set(sheetNamesList)];
                        sheetData[sheetName] = uniqueSheetNames;
                    });
                    
                    // æ•´ä½“å»é‡
                    const uniqueNames = [...new Set(allNames)];
                    
                    // è°ƒè¯•ä¿¡æ¯ï¼šæ˜¾ç¤ºæ¯ä¸ªå·¥ä½œè¡¨çš„æœ‰æ•ˆå§“åæ•°é‡
                    console.log('Excelæ–‡ä»¶åˆ†æç»“æœï¼š');
                    console.log(`æ–‡ä»¶åï¼š${file.name}`);
                    console.log(`å·¥ä½œè¡¨æ•°é‡ï¼š${sheetNames.length}`);
                    console.log('å„å·¥ä½œè¡¨è¯¦ç»†ä¿¡æ¯ï¼š');
                    
                    Object.keys(sheetData).forEach(sheetName => {
                        const sheetNames = sheetData[sheetName];
                        console.log(`  å·¥ä½œè¡¨ "${sheetName}": ${sheetNames.length} ä¸ªæœ‰æ•ˆå§“å`);
                        console.log(`    å§“ååˆ—è¡¨: ${sheetNames.join(', ')}`);
                    });
                    
                    console.log(`æ€»æœ‰æ•ˆå§“åæ•°é‡ï¼š${uniqueNames.length}`);
                    console.log(`å®Œæ•´å§“ååˆ—è¡¨ï¼š${uniqueNames.join(', ')}`);
                    
                    // ä¿å­˜æ•°æ®
                    currentData = {
                        filename: file.name,
                        uploadTime: new Date().toISOString(),
                        sheetData: sheetData,
                        allNames: uniqueNames.sort(),
                        totalCount: uniqueNames.length
                    };
                    
                    names = currentData.allNames;
                    
                    // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
                    localStorage.setItem(STORAGE_KEY, JSON.stringify(currentData));
                    
                    // æ›´æ–°ç•Œé¢
                    updateFileInfo();
                    updateStats();
                    resetLottery();
                    
                    const successMessage = `æˆåŠŸåŠ è½½Excelæ–‡ä»¶ï¼
æ–‡ä»¶åï¼š${file.name}
å·¥ä½œè¡¨æ•°é‡ï¼š${sheetNames.length}
æ€»äººæ•°ï¼š${uniqueNames.length}

è¯¦ç»†ä¿¡æ¯è¯·æŸ¥çœ‹æµè§ˆå™¨æ§åˆ¶å°ã€‚`;
                    
                    alert(successMessage);
                    
                } catch (error) {
                    console.error('æ–‡ä»¶è§£æé”™è¯¯ï¼š', error);
                    alert('æ–‡ä»¶è§£æå¤±è´¥ï¼Œè¯·æ£€æŸ¥Excelæ–‡ä»¶æ ¼å¼æ˜¯å¦æ­£ç¡®');
                }
            };
            
            reader.readAsArrayBuffer(file);
        }
        
        // TXTæ–‡ä»¶è§£æå‡½æ•°
        function loadTXTFile(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const content = e.target.result;
                    const lines = content.split('\n').map(line => line.trim()).filter(line => line);
                    
                    const allNames = [];
                    let processedLines = 0;
                    let skippedLines = 0;
                    
                    console.log(`TXTæ–‡ä»¶è§£æå¼€å§‹ - æ–‡ä»¶å: ${file.name}`);
                    console.log(`æ€»è¡Œæ•°: ${lines.length}`);
                    
                    // è§£ææ¯ä¸€è¡Œ
                    lines.forEach((line, index) => {
                        // è·³è¿‡ç©ºè¡Œ
                        if (!line) {
                            skippedLines++;
                            return;
                        }
                        
                        // å¤„ç†ä¸åŒæ ¼å¼çš„è¡Œ
                        let name = '';
                        
                        // æ ¼å¼1: çº¯å§“åï¼ˆæ¯è¡Œä¸€ä¸ªå§“åï¼‰
                        if (!line.includes(',') && !line.includes('\t') && !line.includes(' ')) {
                            name = line;
                        }
                        // æ ¼å¼2: é€—å·åˆ†éš”
                        else if (line.includes(',')) {
                            const parts = line.split(',');
                            name = parts[0].trim();
                        }
                        // æ ¼å¼3: Tabåˆ†éš”
                        else if (line.includes('\t')) {
                            const parts = line.split('\t');
                            name = parts[0].trim();
                        }
                        // æ ¼å¼4: ç©ºæ ¼åˆ†éš”
                        else if (line.includes(' ')) {
                            const parts = line.split(' ');
                            name = parts[0].trim();
                        }
                        // æ ¼å¼5: å…¶ä»–åˆ†éš”ç¬¦
                        else {
                            const parts = line.split(/[|;]/);
                            name = parts[0].trim();
                        }
                        
                        // éªŒè¯æå–çš„å§“å
                        if (name && isValidName(name)) {
                            allNames.push(name);
                            processedLines++;
                            console.log(`  è¡Œ${index + 1}: "${line}" -> å§“å: "${name}"`);
                        } else {
                            skippedLines++;
                            console.log(`  è¡Œ${index + 1}: "${line}" -> è·³è¿‡ï¼ˆæ— æ•ˆå§“åï¼‰`);
                        }
                    });
                    
                    // å»é‡
                    const uniqueNames = [...new Set(allNames)];
                    
                    console.log(`TXTè§£æç»“æœ:`);
                    console.log(`  å¤„ç†è¡Œæ•°: ${processedLines}`);
                    console.log(`  è·³è¿‡è¡Œæ•°: ${skippedLines}`);
                    console.log(`  æœ‰æ•ˆå§“åæ•°: ${uniqueNames.length}`);
                    console.log(`  å§“ååˆ—è¡¨: ${uniqueNames.join(', ')}`);
                    
                    // å¦‚æœæ²¡æœ‰æ‰¾åˆ°æœ‰æ•ˆå§“åï¼Œæ˜¾ç¤ºé”™è¯¯
                    if (uniqueNames.length === 0) {
                        alert('TXTæ–‡ä»¶ä¸­æ²¡æœ‰æ‰¾åˆ°æœ‰æ•ˆçš„å§“åã€‚è¯·æ£€æŸ¥æ–‡ä»¶æ ¼å¼ï¼Œç¡®ä¿æ¯è¡ŒåŒ…å«ä¸€ä¸ªæœ‰æ•ˆçš„å§“åã€‚');
                        return;
                    }
                    
                    // ä¿å­˜æ•°æ®
                    currentData = {
                        filename: file.name,
                        uploadTime: new Date().toISOString(),
                        fileType: 'txt',
                        allNames: uniqueNames.sort(),
                        totalCount: uniqueNames.length,
                        stats: {
                            processedLines: processedLines,
                            skippedLines: skippedLines,
                            totalLines: lines.length
                        }
                    };
                    
                    names = currentData.allNames;
                    
                    // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
                    localStorage.setItem(STORAGE_KEY, JSON.stringify(currentData));
                    
                    // æ›´æ–°ç•Œé¢
                    updateFileInfo();
                    updateStats();
                    resetLottery();
                    
                    const successMessage = `æˆåŠŸåŠ è½½TXTæ–‡ä»¶ï¼
æ–‡ä»¶åï¼š${file.name}
å¤„ç†è¡Œæ•°ï¼š${processedLines}
è·³è¿‡è¡Œæ•°ï¼š${skippedLines}
æœ‰æ•ˆå§“åæ•°ï¼š${uniqueNames.length}

è¯¦ç»†ä¿¡æ¯è¯·æŸ¥çœ‹æµè§ˆå™¨æ§åˆ¶å°ã€‚`;
                    
                    alert(successMessage);
                    
                } catch (error) {
                    console.error('TXTæ–‡ä»¶è§£æé”™è¯¯ï¼š', error);
                    alert('TXTæ–‡ä»¶è§£æå¤±è´¥ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶æ ¼å¼æ˜¯å¦æ­£ç¡®');
                }
            };
            
            reader.readAsText(file, 'UTF-8');
        }
        
        // æ›´æ–°æ–‡ä»¶ä¿¡æ¯æ˜¾ç¤º
        function updateFileInfo() {
            const fileInfo = document.getElementById('fileInfo');
            const fileNameSpan = document.getElementById('fileName');
            const sheetCountSpan = document.getElementById('sheetCount');
            const totalCountSpan = document.getElementById('totalCount');
            const uploadTimeSpan = document.getElementById('uploadTime');
            const startBtn = document.getElementById('startBtn');
            const deleteBtn = document.getElementById('deleteBtn');
            
            if (currentData) {
                fileInfo.className = 'file-info has-data';
                fileNameSpan.textContent = currentData.filename;
                sheetCountSpan.textContent = Object.keys(currentData.sheetData).length;
                totalCountSpan.textContent = currentData.totalCount;
                uploadTimeSpan.textContent = new Date(currentData.uploadTime).toLocaleString();
                
                startBtn.disabled = false;
                deleteBtn.style.display = 'inline-block';
            } else {
                fileInfo.className = 'file-info';
                fileNameSpan.textContent = 'æœªé€‰æ‹©æ–‡ä»¶';
                sheetCountSpan.textContent = '0';
                totalCountSpan.textContent = '0';
                uploadTimeSpan.textContent = '-';
                
                startBtn.disabled = true;
                deleteBtn.style.display = 'none';
            }
        }
        
        // åˆ é™¤æ•°æ®
        function deleteData() {
            if (confirm('ç¡®å®šè¦åˆ é™¤å½“å‰æ•°æ®å—ï¼Ÿè¿™å°†æ¸…é™¤æ‰€æœ‰å§“åå’Œå†å²è®°å½•ã€‚')) {
                currentData = null;
                names = [];
                history = [];
                
                // æ¸…é™¤æœ¬åœ°å­˜å‚¨
                localStorage.removeItem(STORAGE_KEY);
                localStorage.removeItem(HISTORY_KEY);
                
                // æ›´æ–°ç•Œé¢
                updateFileInfo();
                updateStats();
                resetLottery();
                updateHistoryDisplay();
                
                // é‡ç½®æ–‡ä»¶è¾“å…¥
                document.getElementById('fileInput').value = '';
                
                alert('æ•°æ®å·²åˆ é™¤ï¼');
            }
        }
        
        // æ‹–æ‹½ä¸Šä¼ åŠŸèƒ½
        function setupDragAndDrop() {
            const uploadArea = document.getElementById('uploadArea');
            
            uploadArea.addEventListener('dragover', function(e) {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });
            
            uploadArea.addEventListener('dragleave', function(e) {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
            });
            
            uploadArea.addEventListener('drop', function(e) {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    const file = files[0];
                    if (file.name.match(/\.(xlsx|xls|txt)$/i)) {
                        // æ¨¡æ‹Ÿæ–‡ä»¶é€‰æ‹©
                        const event = {
                            target: {
                                files: [file]
                            }
                        };
                        loadFile(event);
                    } else {
                        alert('è¯·æ‹–æ‹½Excelæ–‡ä»¶ï¼ˆ.xlsx æˆ– .xlsï¼‰æˆ–TXTæ–‡ä»¶ï¼ˆ.txtï¼‰');
                    }
                }
            });
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            // è¯»å–æœ¬åœ°å­˜å‚¨çš„æ•°æ®
            loadFromStorage();
            
            // è®¾ç½®æ‹–æ‹½ä¸Šä¼ 
            setupDragAndDrop();
            
            // è¯»å–å†å²è®°å½•
            loadHistory();
            
            // åŠ è½½é«˜çº§è®¾ç½®
            loadSettings();
            
            console.log('ç­çº§æŠ½å¥–ç³»ç»Ÿå·²åŠ è½½ï¼');
            if (names.length > 0) {
                console.log(`å…±æœ‰ ${names.length} ä¸ªå§“åå‚ä¸æŠ½å¥–`);
            }
            
            // æ£€æŸ¥TXTæ–‡ä»¶æ”¯æŒ
            if (window.FileReader) {
                console.log('æ”¯æŒTXTæ–‡ä»¶è¯»å–åŠŸèƒ½');
            }
        });
        
        // ä»æœ¬åœ°å­˜å‚¨åŠ è½½æ•°æ®
        function loadFromStorage() {
            try {
                const storedData = localStorage.getItem(STORAGE_KEY);
                if (storedData) {
                    currentData = JSON.parse(storedData);
                    names = currentData.allNames || [];
                    updateFileInfo();
                    updateStats();
                }
            } catch (error) {
                console.error('åŠ è½½æœ¬åœ°æ•°æ®å¤±è´¥ï¼š', error);
            }
        }
        
        // åŠ è½½å†å²è®°å½•
        function loadHistory() {
            try {
                const storedHistory = localStorage.getItem(HISTORY_KEY);
                if (storedHistory) {
                    history = JSON.parse(storedHistory);
                    updateHistoryDisplay();
                }
            } catch (error) {
                console.error('åŠ è½½å†å²è®°å½•å¤±è´¥ï¼š', error);
            }
        }
        
        // ä¿å­˜å†å²è®°å½•
        function saveHistory() {
            try {
                localStorage.setItem(HISTORY_KEY, JSON.stringify(history));
            } catch (error) {
                console.error('ä¿å­˜å†å²è®°å½•å¤±è´¥ï¼š', error);
            }
        }

        // æ·»åŠ é”®ç›˜å¿«æ·é”®
        document.addEventListener('keydown', function(event) {
            if (event.code === 'Space' && !isDrawing) {
                event.preventDefault();
                startLottery();
            }
        });
    </script>
</body>
</html>